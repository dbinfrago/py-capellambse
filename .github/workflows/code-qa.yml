# SPDX-FileCopyrightText: Copyright DB InfraGO AG
# SPDX-License-Identifier: CC0-1.0
# vim:set fdm=marker:

name: Code QA

on:
  pull_request:
  push:
    branches: [master]
    tags: ["v*.*.*"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.ref_type == 'tag' && github.sha || '0' }}
  cancel-in-progress: true

jobs:
  pre-commit: # {{{1
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: "3.12"
      - name: Run Pre-Commit
        run: make lint

  sdist: # {{{1
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Build sdist
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          command: sdist
          args: --out dist
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: sdist
          path: dist/
          if-no-files-found: error

  build: # {{{1
    name: Build wheels for ${{ matrix.platform.tag }} ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux manylinux {{{
          - runner: ubuntu-22.04
            target: x86_64
            tag: manylinux
            manylinux: auto
            unittests: true
          - runner: ubuntu-22.04
            target: x86
            tag: manylinux
            manylinux: auto
          - runner: ubuntu-22.04
            target: aarch64
            tag: manylinux
            manylinux: auto
          - runner: ubuntu-22.04
            target: armv7
            tag: manylinux
            manylinux: auto
          - runner: ubuntu-22.04
            target: s390x
            tag: manylinux
            manylinux: auto
          - runner: ubuntu-22.04
            target: ppc64le
            tag: manylinux
            manylinux: auto
          # }}}
          # Linux musllinux {{{
          - runner: ubuntu-22.04
            target: x86_64
            tag: musllinux
            manylinux: musllinux_1_2
          - runner: ubuntu-22.04
            target: x86
            tag: musllinux
            manylinux: musllinux_1_2
          - runner: ubuntu-22.04
            target: aarch64
            tag: musllinux
            manylinux: musllinux_1_2
          - runner: ubuntu-22.04
            target: armv7
            tag: musllinux
            manylinux: musllinux_1_2
          # }}}
          # macOS {{{
          - runner: macos-15-intel
            target: x86_64
            tag: macos
          - runner: macos-latest
            target: aarch64
            tag: macos
            unittests: true
          # }}}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.10"
      - uses: astral-sh/setup-uv@v7
        if: matrix.platform.unittests
        with:
          python-version: "3.10"
          cache-python: "true"
          ignore-nothing-to-cache: "true"
      - name: Build abi3 wheel
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist -i python3.10
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: ${{ matrix.platform.manylinux }}
      - name: Run unittests with Python 3.10
        if: matrix.platform.unittests
        env:
          UV_PYTHON: cp310
        shell: bash
        run: |-
          echo "::group::Prepare test environment"
          uv sync --group test --no-install-project
          . .venv/bin/activate
          uv pip install dist/*-"$UV_PYTHON"-*.whl
          echo "::endgroup::"

          make test
      - name: Build 3.13t wheel
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist -i python3.13t
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: ${{ matrix.platform.manylinux }}
      - name: Build 3.14t wheel
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist -i python3.14t
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: ${{ matrix.platform.manylinux }}
      - name: Run unittests with Python 3.14t
        if: matrix.platform.unittests
        env:
          UV_PYTHON: cp314t
        shell: bash
        run: |-
          echo "::group::Prepare test environment"
          uv sync --group test --no-install-project
          . .venv/bin/activate
          uv pip install dist/*-"$UV_PYTHON"-*.whl
          echo "::endgroup::"

          make test
      - name: Assert that exactly one abi3 wheel exists
        shell: bash
        run: |-
          wheels=(dist/*-abi3-*.whl)
          if [[ "${#wheels[@]}" -eq 1 ]] && [[ -e "${wheels[0]}" ]]; then
            echo "OK"
          else
            echo "Expected exactly one abi3 wheel, found ${#wheels[@]}:"
            printf ' - %s\n' "${wheels[@]}"
            exit 1
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wheels-${{ matrix.platform.tag }}-${{ matrix.platform.target }}
          path: dist/
          if-no-files-found: error

  build-windows: # {{{1
    name: Build wheels for windows ${{ matrix.platform.target }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - target: x64
            unittests: true
          - target: x86
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.10
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.10"
          architecture: ${{ matrix.platform.target }}
      - name: Set up Python 3.13t
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.13t"
          architecture: ${{ matrix.platform.target }}
      - name: Set up Python 3.14t
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.14t"
          architecture: ${{ matrix.platform.target }}
      - uses: astral-sh/setup-uv@v7
        if: matrix.platform.unittests
        with:
          python-version: "3.10"
          cache-python: "true"
          ignore-nothing-to-cache: "true"
      - name: Build abi3 wheel
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist -i python3.10
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Run unittests with Python 3.10
        if: matrix.platform.unittests
        env:
          UV_PYTHON: cp310
        shell: bash
        run: |-
          echo "::group::Prepare test environment"
          uv sync --group test --no-install-project
          . .venv/Scripts/activate
          uv pip install dist/*-"$UV_PYTHON"-*.whl
          echo "::endgroup::"

          make test
      - name: Build 3.13t wheel
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist -i python3.13t
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Build 3.14t wheel
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380 # v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist -i python3.14t
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Run unittests with Python 3.14t
        if: matrix.platform.unittests
        env:
          UV_PYTHON: cp314t
        shell: bash
        run: |-
          echo "::group::Prepare test environment"
          uv sync --group test --no-install-project
          . .venv/Scripts/activate
          uv pip install dist/*-"$UV_PYTHON"-*.whl
          echo "::endgroup::"

          make test
      - name: Assert that exactly one abi3 wheel exists
        shell: bash
        run: |-
          wheels=(dist/*-abi3-*.whl)
          if [[ "${#wheels[@]}" -eq 1 ]] && [[ -e "${wheels[0]}" ]]; then
            echo "OK"
          else
            echo "Expected exactly one abi3 wheel, found ${#wheels[@]}:"
            printf ' - %s\n' "${wheels[@]}"
            exit 1
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist/
          if-no-files-found: error

  publish: # {{{1
    name: Publish release
    runs-on: ubuntu-latest
    needs: [build, build-windows, sdist, example-notebooks]
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/project/capellambse
    permissions:
      id-token: write
    steps:
      - name: Download sdist
        uses: actions/download-artifact@v7
        with:
          path: dist/
          name: sdist
      - name: Download built wheels
        uses: actions/download-artifact@v7
        with:
          path: dist/
          pattern: wheel-*
          merge-multiple: true
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
      - name: Push to release branch
        continue-on-error: true
        env:
          GITHUB_REF: ${{github.ref}}
        run: |-
          releasever="$(echo "$GITHUB_REF" | grep -Po '(?<=^refs/tags/v)(?:0\.)?[1-9][0-9]*').x"
          if [[ "$releasever" = 0.5.x ]]; then releasever="${releasever%.x}"; fi
          git push origin "HEAD:release-$releasever"

  example-notebooks: # {{{1
    name: Run and verify the example notebooks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: "3.12"
      - name: Run example notebooks
        run: make verify-examples

  docs: # {{{1
    name: Build documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: "3.12"
      - name: Install system-level dependencies
        run: sudo apt-get install -y pandoc
      - name: Create docs
        env:
          SPHINXOPTS: ""
        run: make docs
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/master'
        with:
          force_orphan: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/build/html

  downstream-tests: # {{{1
    name: Run downstream tests in ${{matrix.repo}}
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        repo:
          - dbinfrago/capellambse-context-diagrams
          - dbinfrago/capella-polarion
          - dbinfrago/json2capella
          - dbinfrago/capella-ros-tools
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          filter: tree:0
          repository: ${{matrix.repo}}
      - uses: actions/download-artifact@v7
        with:
          path: dist/
          name: wheels-manylinux-x86_64
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"
          python-version: "3.13"
      - name: Setup deno (for context-diagrams only)
        uses: denoland/setup-deno@v2
        if: matrix.repo == 'dbinfrago/capellambse-context-diagrams'
        with:
          deno-version: "2.5.x"
      - run: |-
          echo SETUPTOOLS_SCM_PRETEND_VERSION="$(
            uvx --with setuptools_scm python -c \
              "import setuptools_scm as scm; print(scm.get_version())"
          )" >> "$GITHUB_ENV"
      - run: uv add --dev ./dist/*-abi3-*.whl pytest pytest-xdist && uv sync
      - run: uv run pytest -n auto
